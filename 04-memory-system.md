# 04. メモリ管理システム

## なぜメモリが必要か

AIは各セッションで記憶がリセットされる。
メモリシステムがあれば：

- 前回の会話を覚えている
- 長期的なプロジェクトを管理できる
- ユーザーの好みを学習できる

## 二層メモリ構造

### 1. 日次メモリ（memory/YYYY-MM-DD.md）

その日の生ログ。起きたことをそのまま記録。

```markdown
# 2026-02-05 メモリ

## 今日やったこと

### Threads新アカウント追加
- @note_kakuzou セットアップ完了
- @mami_mama_note セットアップ完了
- テンプレート各200件以上に拡充

### madoka_lovetech修正
- JSONエラー修正
- タイマー再設定

## 技術メモ
- systemdタイマーは `RandomizedDelaySec=300` で分散

## 明日やること
- 他アカウントのテンプレート拡充検討
```

### 2. 長期メモリ（MEMORY.md）

日次メモリから抽出した、長期的に重要な情報。

```markdown
# MEMORY.md - 長期記憶

## ユーザーの好み
- 簡潔なやり取りを好む
- 絵文字は控えめに

## 重要な決定
- Threadsは1日5回投稿が基本
- テンプレートは200件以上を目標

## 進行中のプロジェクト
- Threads 7アカウント運用中

## 学んだこと
- JSONは壊れやすい、常にバリデーション
```

## メモリの読み書きルール

### 読み込みタイミング

1. **毎セッション開始時**
   - 今日の日次メモリ
   - 昨日の日次メモリ
   - MEMORY.md（メインセッションのみ）

2. **必要に応じて**
   - 過去の日次メモリを検索

### 書き込みタイミング

1. **リアルタイム**
   - 重要な決定・成果があった時
   - ユーザーが「覚えて」と言った時

2. **セッション終了時**
   - その日のサマリーを追記

3. **定期メンテナンス（ハートビート中）**
   - 日次メモリをレビュー
   - MEMORY.mdに重要事項を転記
   - 古い情報を整理

## 実装パターン

### 日次メモリの自動作成

```bash
# memory/ に今日のファイルがなければ作成
TODAY=$(date +%Y-%m-%d)
if [ ! -f "memory/${TODAY}.md" ]; then
  echo "# ${TODAY} メモリ\n\n## 今日やったこと\n" > "memory/${TODAY}.md"
fi
```

### メモリ検索

Clawdbotの `memory_search` ツールを使用：

```
memory_search(query="Threads アカウント 設定")
```

結果から必要な部分だけ `memory_get` で取得：

```
memory_get(path="memory/2026-02-05.md", from=10, lines=20)
```

## セキュリティ考慮

### メインセッション vs 共有セッション

- **メインセッション**（ユーザーとの1対1）
  → MEMORY.md を読み書きOK

- **共有セッション**（グループチャット、他ユーザー）
  → MEMORY.md は読まない（個人情報漏洩防止）
  → 日次メモリも慎重に

### 機密情報の扱い

```markdown
## ❌ MEMORY.mdに書かない
- パスワード
- APIキー
- 個人的な秘密

## ✅ .secrets/ に保存
- 認証情報はJSONファイルで別管理
```

## メンテナンスのコツ

### 1. 定期的な整理（週1回程度）

```markdown
# ハートビート時にやること
1. 過去1週間の日次メモリをレビュー
2. 重要な情報をMEMORY.mdに転記
3. 古くなった情報を削除
```

### 2. 検索しやすい形式

```markdown
# ✅ 良い例：キーワードが明確
## Threads運用
- @rinna_fukuen: 復縁コーチ、5回/日
- @note_kakuzou: 40代note挑戦、5回/日

# ❌ 悪い例：曖昧
## 今日の作業
色々やった。アカウント増やした。
```

### 3. 日付を明記

```markdown
# ✅ 良い例
## トークン有効期限
- @rinna_fukuen: 2026-04-02まで
- @note_kakuzou: 2026-04-06まで
```

## トラブルシューティング

### メモリが見つからない

```bash
# ファイルの存在確認
ls -la memory/

# 権限確認
chmod 644 memory/*.md
```

### メモリが古い

- ハートビートでメンテナンスを実行
- MEMORY.mdを手動で整理
